本文档是对RISC-V Core-Local Interrupt Controller (CLIC)技术文档的中文试行翻译版本，基于2021.10.28发布的v0.9草案版本进行翻译。由于本人水平有限，欢迎读者批评斧正。文档可以在[官方的仓库](https://github.com/riscv/riscv-fast-interrupt)中找到。

# 背景与动机

内核中断控制器（Core-Local Interrupt Controller，CLIC）是设计给RISC-V系统提供低延迟、向量以及抢占的中断控制器。当启用CLIC时，CLIC会包含并替代原生的基本RISC-V内核中断机制。CLIC的基础设计只需要很少的硬件单元，但是可以通过额外的扩展来提供所需要的硬件加速。CLIC的目标是为多种的软件ABI（Application Binary Interface，应用二进制接口）以及中断模型提供支持，而不需要复杂的硬件结构从而影响到高性能处理器实现的性能。

CLIC还支持一个新的可选向量硬件中断（Selective Hardware Vectoring）特性来允许用户对每个中断进行优化：实现为快速响应抑或是更小的代码长度。

虽然现在的CLIC仅提供单个硬件线程（RISC-V-compatible hardware threads，harts）内的中断控制，在CLIC未来的扩展中可能会加入对核内多个硬件线程所提供的定向中断支持，正如它的名字一样（且CLIC听起来比HLIC或者HIC更好）。

## 现有的RISC-V中断系统

现有的RISC-V中断系统已经支持中断抢占，但仅基于特权模式下的实现。在任何一个时刻，一个RISC-V硬件线程都会运行在一个特定的特权模式下。每个特权模式都有一个全局中断使能位，即MIE/SIE/UIE，分别位于`mstatus`/`sstatus`/`ustatus`寄存器当中，它们控制在当前或者更高级别的特权模式下中断是否能响应；而对于比当前更低级别的特权模式下的所有中断都是被屏蔽掉的。任何从比当前更高级别的特权模式下使能的中断都会停止当前特权模式下程序的执行，切换到更高级别的特权模式响应中断，并执行对应的中断服务程序。每个特权模式都有其独有的中断状态寄存器（机器模式下的`mepc`/`mcause`，监管者模式下的`sepc`/`scause`，用户模式下的`uepc`/`ucause`）来支持抢占的实现，或者概括为`x`模式下的中断状态寄存器`xepc`来提供对抢占的实现。当被一个更高特权模式下的中断抢占时，系统会将当前所处的特权模式级别以及中断使能状态压入到所要切换到的更高的特权模式下的`xstatus`寄存器中的`xpp`以及`xpie`堆栈中。

`xtvec`寄存器定义了中断向量表的中断模式以及基地址。WARL（“Write Any Values, Reads Legal Values”，写任意值，读合法值）寄存器`xtvec`的低位用来指示当前所支持的中断模型。原生的xtvec寄存器中中断模型的设定只有两种（*00以及*01），表示跳转到中断服务程序将使用非向量或者向量的模式。而高位则保存有4字节（或者更大）对齐的表头基地址（对于非向量模式，这是所有中断服务程序的共同入口；对于向量模式，这是中断向量表的基地址）。

WARL表示“Write Any Values, Reads Legal Values”，也就是说可以尝试写入任何值但是只有支持的值可以被实际得写入。

通过将`mtvec`最低两位的值设置为保留值（*11）可以启用CLIC模式。

## 对比CLIC与PLIC

标准RISC-V平台级中断控制器（Platform-Level Interrupt Controller，PLIC）为共享平台级别的中断提供了集中的中断仲裁以及路由，之后仅发送给每个hart的各个特权模式（`meip`/`seip`/`ueip`）单一外部中断信号。

CLIC是PLIC的互补。更小的单核系统可能只需要实现一个CLIC，而多核的系统则需要每个核实现一个独立的CLIC以及一个共享的PLIC。PLIC的`xeip`信号将会被看作是由每个核内CLIC触发的hart内部中断。

## 对比CLIC与原生的基础中断控制器

现存原生的基础中断控制器是一个很小的硬件单元， 其提供了基于早期的设计思想下的核内异常，包括对软件中断、计时中断以及外部中断信号（`xip`寄存器中的`xsip`/`xtip`/`xeip`信号）的管理。这个基本的控制器同样允许在`xip`寄存器的第16位或更高位自定义额外的快速中断信号。

下文所描述的对于`xtvec`寄存器新的中断模式的设置将用于启用CLIC模式来替代原生的基本中断模式。而无论是原生的基本中断模式还是CLIC中断模式都可能需要平台级别的相关设定。

## 对比CLIC与高级中断架构

高级中断架构（Advanced Interrupt Architecture，AIA）支持消息告知中断模式（Message-Signaled Interrupts，MSIs）、支持高级PLIC（APLIC）系统、支持多hart模式以及支持虚拟化。类似于CLIC，所有中断（不仅仅是外部中断）的相对优先级都可以进行配置。CLIC的目标是在每个核内都实现一个CLIC系统，且可选支持如下的特性：给予每个中断源以不同的陷阱（trap）入口地址、中断的抢占基于可调节的优先级阈值控制，以及软件尾链（Tailchaining）的支持。